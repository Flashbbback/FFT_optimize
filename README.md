# AVX加速FFT核心模块使用手册
## 一、项目背景介绍
本模块是专为信号处理场景设计的**AVX指令集加速FFT核心组件**，尽可能加快FFT计算过程。模块包含两类核心实现：AVX单精度浮点版和AVX定点版（Q15格式）,兼顾计算速度、内存占用与精度平衡。

适用场景：频谱分析、通信系统、实时信号处理等需高效FFT运算的场景，支持从256点到16384点（2⁸~2¹⁴）的2次幂尺寸FFT计算，适配支持AVX指令集的CPU硬件。


## 二、核心功能说明
| 功能类型         | 具体描述                                                                 |
|------------------|--------------------------------------------------------------------------|
| AVX浮点版FFT     | 基于AVX 256位向量指令集，并行处理8个单精度浮点数，无冗余旋转因子存储，大尺寸通过实时重排表优化访问 |
| AVX定点版FFT     | Q15格式（1位符号位+15位小数位）量化计算，小尺寸（M=2/4/8）旋转因子硬编码，中大型（M≥16）实时重排，内存占用极低 |
| 上下文资源管理   | 提供上下文初始化（预计算位反转索引、重排旋转因子表）与资源释放接口，支持多尺寸FFT复用 |


## 三、项目结构与文件说明
### 1. 整体架构
本项目采用分层设计，清晰分离了对外接口、内部实现和工具函数：

```
d:\FFT\delivery\
├── include\           # 对外接口目录
│   └── fft_lib.h      # 公共头文件，定义对外API
├── src\               # 源码实现目录
│   ├── fft_internal.h # 内部头文件，定义内部数据结构和函数
│   ├── fft_tables.c   # 数据层：旋转因子表生成与管理
│   ├── fft_utils.c    # 工具层：位反转等通用功能
│   ├── fft_avx_float.c # 计算核：AVX浮点版本实现
│   └── fft_avx_fixed.c # 计算核：AVX定点版本实现
├── demo.c             # 实现案例
├── Perform.c          # 测试程序与性能评估
├── makefile           # 编译脚本
└── README.md          # 使用手册
```

### 2. 模块职责说明
| 文件               | 主要职责                                   | 核心功能                                     |
|--------------------|--------------------------------------------|----------------------------------------------|
| include/fft_lib.h  | 对外接口定义                               | 声明公共API，隐藏内部实现细节                |
| src/fft_internal.h | 内部数据结构与函数声明                     | 定义FFTContext结构、内部常量和辅助函数       |
| src/fft_tables.c   | 上下文管理与旋转因子表生成                 | 创建、初始化和释放FFTContext，预计算旋转因子 |
| src/fft_utils.c    | 工具函数实现                               | 位反转算法、通用计算辅助函数                 |
| src/fft_avx_float.c | AVX浮点版FFT实现                          | 使用AVX指令集加速浮点FFT计算                 |
| src/fft_avx_fixed.c | AVX定点版FFT实现                          | 使用AVX指令集加速Q15格式FFT计算              |
| Perform.c             | 性能评估                                | 测量不同尺寸FFT性能                         |
| demo.c             | 测试用例                                   | 验证功能正确性                              |


## 四、关键算法与实现解释
### 1. 核心FFT算法框架
所有版本均基于**基-2蝶形运算**优化，通过分治思想将N点FFT拆解为多个小尺寸子FFT，核心步骤：
1. 位反转重排：对输入序列按二进制位反转排序，确保蝶形运算时数据连续访问，提升缓存命中率；
2. 多阶段蝶形运算：按层级（s=1至log₂N）处理，每阶段处理M=2ˢ点子FFT，通过旋转因子合并子结果；
3. AVX并行加速：利用256位向量寄存器（`__m256`/`__m256i`）并行计算8个浮点/16个定点数据，提升吞吐量。


### 2. 定点版精度控制
- 量化范围：Q15格式支持[-1.0, 1.0)浮点范围映射，通过饱和截断避免溢出（超出`INT16_MAX`/`INT16_MIN`时强制钳位）；
- 乘法优化：使用`_mm256_mulhrs_epi16`指令实现带舍入的16位整数乘法，减少量化误差累积。


### 3. 旋转因子重排
对于预计算的旋转因子，为了保证在FFT计算过程中能够连续的读取旋转因子，将计算好的旋转因子表根据计算方式进行了重排，使得浮点版本中M>=8以及定点版M>=16的数据能够直接读取连续的8个旋转因子，大大提升了运行速度，在我们的测试中，速度提升近一倍。


## 五、上手使用指南
### 1. 环境要求
| 类别         | 具体要求                                                                 |
|--------------|--------------------------------------------------------------------------|
| 操作系统     | Windows（依赖`_aligned_malloc`/`_aligned_free`）                         |
| 编译器       | 支持AVX指令集的C编译器（MSVC、GCC 4.7+、Clang 3.1+），需启用AVX编译选项 |
| 硬件         | 支持AVX指令集的CPU（Intel Sandy Bridge及以上、AMD Bulldozer及以上）       |
| 数据要求     | 输入/输出数组需32字节对齐（推荐用`_aligned_malloc`分配），FFT尺寸为2的幂 |

### 2. 编译步骤
#### （1）使用Makefile编译
```bash
# 使用默认的Perform.c作为主文件（性能测试）
make

# 指定使用demo.c作为主文件
make MAIN_FILE=demo.c

# 指定使用其他主文件
make MAIN_FILE=your_main_file.c

# 清理生成的文件
make clean
```

#### （2）手动编译（GCC示例）
```bash
gcc -mavx2 -O2 -Iinclude src/fft_tables.c src/fft_utils.c src/fft_avx_float.c src/fft_avx_fixed.c main.c -o avx_fft_demo
```

### 3. 核心接口说明
#### （1）上下文初始化
```c
FFTContext* trig_table(int max_size);
```
- 功能：预计算位反转索引、中大型旋转因子重排表（M≥16）；
- 参数：`max_size`为支持的最大FFT尺寸（必须为2的幂，如1024、2048）；
- 返回值：成功返回上下文指针，失败返回`NULL`（内存分配失败）。

#### （2）上下文资源释放
```c
void free_trig_table(FFTContext* ctx);
```
- 功能：释放上下文占用的所有资源（重排表、位反转索引等），避免内存泄漏；
- 参数：`ctx`为已初始化的上下文指针。

#### （3）AVX浮点版FFT
```c
void fft_AVX(float* real, float* imag, int N, FFTContext* ctx);
```
- 功能：对输入的浮点信号执行FFT变换，结果覆盖原输入数组；
- 参数：
  - `real`：输入/输出实部数组（32字节对齐，长度N）；
  - `imag`：输入/输出虚部数组（32字节对齐，长度N）；
  - `N`：FFT尺寸（2的幂，且≤`max_size`）；
  - `ctx`：已初始化的上下文指针。

#### （4）AVX定点版FFT
```c
void fft_AVX_fixedP(int16_t* real, int16_t* imag, int N, FFTContext* ctx);
```
- 功能：对Q15格式定点信号执行FFT变换，结果覆盖原输入数组；
- 参数：
  - `real`：输入/输出实部数组（32字节对齐，长度N，Q15格式）；
  - `imag`：输入/输出虚部数组（32字节对齐，长度N，Q15格式）；
  - `N`：FFT尺寸（2的幂，且≤`max_size`）；
  - `ctx`：已初始化的上下文指针。

### 4. 使用示例
```
demo.c
```


## 五、集成指南
### 1. 项目集成步骤
1. **包含头文件**：在需要使用FFT功能的源文件中包含 `fft_lib.h`
   ```c
   #include "include/fft_lib.h"
   ```

2. **添加源文件**：将src目录下的所有源文件添加到目标项目中
   - src/fft_tables.c
   - src/fft_utils.c
   - src/fft_avx_float.c
   - src/fft_avx_fixed.c

3. **编译选项**：确保编译时启用以下选项
   - 启用AVX指令集（GCC：`-mavx2`，MSVC：`/arch:AVX2`）
   - 优化级别建议使用O2或更高（`-O2`/`/O2`）

### 2. 性能优化建议
- **数据对齐**：确保所有输入/输出数组使用`_aligned_malloc`或其他对齐分配函数分配，保证32字节对齐
- **上下文复用**：对于多个相同尺寸的FFT计算，复用同一个FFTContext以避免重复初始化开销
- **批量处理**：尽可能批量处理多个FFT任务，减少内存分配和释放次数

### 3. 注意事项
- **数据尺寸**：FFT尺寸必须为2的幂，否则计算结果将不正确
- **定点精度**：定点版输入信号幅值需≤1.0，超出范围将导致量化精度损失
- **内存管理**：必须在所有计算完成后调用`free_trig_table`释放上下文资源
- **硬件兼容**：确保目标平台支持AVX指令集，否则程序可能崩溃或运行异常


## 六、测试与性能评估
### 1. 测试程序
项目提供的`main.c`包含完整的测试用例，支持：
- 验证浮点版和定点版FFT计算结果正确性
- 测量不同尺寸（256点至16384点）FFT的计算性能
- 比较定点版与浮点版的精度差异

### 2. 实际测试性能数据
| FFT尺寸 | 迭代版性能(ms) | 浮点版性能(ms) | 浮点速度倍数 | 定点版性能(ms) | 定点速度倍数 |
|---------|--------------|---------------|------------|---------------|------------|
| 256       | 0.001709       | 0.000413        | 4.14       x | 0.000327        | 5.23       x |
| 512       | 0.003380       | 0.000829        | 4.08       x | 0.000619        | 5.46       x |
| 1024      | 0.006886       | 0.001792        | 3.84       x | 0.001251        | 5.51       x |
| 2048      | 0.013895       | 0.003826        | 3.63       x | 0.002610        | 5.32       x |
| 4096      | 0.030122       | 0.008569        | 3.52       x | 0.005620        | 5.36       x |
| 8192      | 0.060160       | 0.022063        | 2.73       x | 0.012025        | 5.00       x |
| 16384     | 0.165132       | 0.064274        | 2.57       x | 0.038533        | 4.29       x |

*注：实际测试数据基于当前平台。迭代版作为基准，浮点版速度约为迭代版的2倍，定点版速度约为迭代版的4倍左右。*

### 3. 精度误差分析

#### 3.1 AVX浮点版精度
- **实部误差**：最大误差约为10⁻⁸量级，平均误差约为10⁻¹⁰量级
- **虚部误差**：最大误差约为6×10⁻⁸量级，平均误差约为10⁻¹⁰量级
- **幅度相对误差**：最大误差<0.0001%，精度极高

#### 3.2 AVX定点版精度（Q15格式）
- **实部误差**：最大误差约为5×10⁻³量级，平均误差约为5×10⁻⁵量级
- **虚部误差**：最大误差约为6×10⁻²量级，平均误差约为1.5×10⁻⁴量级
- **幅度相对误差**：最大误差约为7.39%，主要出现在小幅度信号中

#### 3.3 精度结论
- **浮点版**：精度极高，与迭代版FFT计算结果几乎完全一致，适用于对精度要求极高的场景
- **定点版**：在保证计算速度的同时，提供了可接受的精度，对于大多数实时信号处理应用场景已足够精确


